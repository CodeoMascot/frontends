<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>HTML 5 Boilerplate</title>
</head>

<body>
  <div>Ver 2</div>
  <div id="demo">no JS</div>
  <br>
  <br>

  <button id="subscribe">Subscribe</button>
  <button id="push">Push</button>
  <button id="send">Send</button>

  <script type="text/javascript">
    // JS Check
    const statusSpan = document.querySelector('#demo');
    const pushButton = document.querySelector('#push');
    const sendButton = document.querySelector('#send');
    const subscribeButton = document.querySelector('#subscribe');

    statusSpan.innerHTML = "<br>JS: Works";

    // Notify check
    const notificationSupported = 'Notification' in window;
    statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Notification Supported: ${notificationSupported}`);

    // SW Check
    if ("serviceWorker" in navigator) {

      statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>SW: Available`);

      const registerServiceWorker = async () => {
        await navigator.serviceWorker.register('./sw1.js');
        const registration = await navigator.serviceWorker.ready;
        if (registration.active) {
          statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>SW: Active`);
        }
      }

      registerServiceWorker();
    }

    pushButton.addEventListener('click',  async () => {
      const apiUrl = 'https://ca9akfgcre.execute-api.us-east-1.amazonaws.com';

      const response = await (await fetch(`${apiUrl}/public-key`)).json();
      const publicKey = response.publicKey;

      await subscribeToPushMessages(registration, publicKey);

      const registration = await navigator.serviceWorker.getRegistration();
      const pushSubscription = await registration.pushManager.getSubscription();

      if (pushSubscription) {
        statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Push: ${pushSubscription.endpoint}`);
      }
      else {
        statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Push: Null`);
      }
    });

    const base64UrlToUint8Array = base64UrlData => {
      const padding = '='.repeat((4 - base64UrlData.length % 4) % 4);
      const base64 = (base64UrlData + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      const rawData = atob(base64);
      const buffer = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        buffer[i] = rawData.charCodeAt(i);
      }

      return buffer;
    };
    const subscribeToPushMessages = (registration, publicKey) => registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: base64UrlToUint8Array(publicKey)
    });


    subscribeButton.addEventListener('click', async () => {
      if (Notification.permission === 'granted') {
        statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Notify Permission: Already Granted`);
      }
      else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Notify Permission: Granted`);
        }
        else {
          statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Notify Permission: Denied`);
        }
      }
      else {
        statusSpan.innerHTML = (`${statusSpan.innerHTML}<br><br>Notify Permission: Already Denied`);

      }

    });


    sendButton.addEventListener('click', () => {
      const options = {
        body: 'Simple Chrome Desktop Notification',
        dir: 'ltr',
        image: 'https://cdn-icons-png.flaticon.com/512/2922/2922546.png'
      };
      const notification = new Notification('Notification', options);

      notification.onclick = function () {
        window.open('https://www.google.com');
      };
    });


  </script>
</body>

</html>
